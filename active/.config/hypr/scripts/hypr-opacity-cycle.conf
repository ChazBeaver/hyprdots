#!/usr/bin/env bash
set -euo pipefail

command -v jq >/dev/null 2>&1 || exit 1

apply_all() {
  local blur_size="$1"
  local blur_passes="$2"
  local active="$3"
  local inactive="$4"
  local fullscreen="$5"

  hyprctl --batch "
keyword decoration:blur:enabled 1;
keyword decoration:blur:size ${blur_size};
keyword decoration:blur:passes ${blur_passes};
keyword decoration:blur:new_optimizations 1;
keyword decoration:blur:xray 0;
keyword decoration:blur:ignore_opacity 0;

keyword decoration:active_opacity ${active};
keyword decoration:inactive_opacity ${inactive};
keyword decoration:fullscreen_opacity ${fullscreen};

# Force all windows (beats Omarchy app rules)
keyword windowrulev2 opacity ${active} ${inactive}, class:.*;
keyword windowrulev2 opacity ${fullscreen} ${fullscreen}, fullscreen:1;
"
}

# Read current active opacity (this is our STATE)
CUR="$(hyprctl -j getoption decoration:active_opacity | jq -r '.float' 2>/dev/null || echo 0.75)"

# Decide next mode based on current opacity thresholds
# <= 0.80  -> currently Transparent -> go to Blur
# <= 0.92  -> currently Blur        -> go to Opaque
# >  0.92  -> currently Opaque      -> go to Transparent
awk -v cur="$CUR" 'BEGIN{
  if (cur <= 0.80)      print 2;
  else if (cur <= 0.92) print 3;
  else                  print 1;
}' | {
  read -r NEXT_STATE
  case "$NEXT_STATE" in
    1) apply_all 1  1  0.75 0.65 0.75 ;;   # Transparent
    2) apply_all 4  2  0.85 0.75 0.85 ;;   # Blur
    3) apply_all 0  0  1.00 1.00 1.00 ;;   # Opaque
  esac
}
